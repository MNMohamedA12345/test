<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developer Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.21.4/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
      if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
          var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
          var firstSheetName = workbook.SheetNames[0];
          var worksheet = workbook.Sheets[firstSheetName];
          var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
          var filteredData = jsonData.filter(row => row.some(filledCell));
          var headerRowIndex = filteredData.findIndex((row, index) =>
            row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
          );
          if (headerRowIndex === -1 || headerRowIndex > 25) {
            headerRowIndex = 0;
          }
          var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
          csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
          return csv;
        } catch (e) {
          console.error('Error in loadFileData:', e);
          return "";
        }
      }
      return gk_fileData[filename] || "";
    }
  </script>
</head>
<body class="bg-gray-100 min-h-screen px-4 sm:px-6 md:px-8 py-8">
  <div id="root" className="w-full md:w-[70%] max-w-7xl mx-auto"></div>
  <div id="error-fallback" className="hidden text-center text-red-700 p-4"></div>
  <script type="text/babel" data-presets="react">
    class ErrorBoundary extends React.Component {
      state = { error: null };
      static getDerivedStateFromError(error) {
        return { error: error.message };
      }
      render() {
        if (this.state.error) {
          return (
            <div className="p-4 bg-red-100 text-red-700 rounded-lg mx-auto max-w-7xl">
              <h2 className="text-lg font-semibold">Something went wrong</h2>
              <p>{this.state.error}</p>
            </div>
          );
        }
        return this.props.children;
      }
    }

    function ConfirmationModal({ isOpen, title, message, onConfirm, onCancel }) {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
            <h2 className="text-lg font-semibold text-gray-800 mb-4">{title}</h2>
            <p className="text-gray-600 mb-6">{message}</p>
            <div className="flex justify-end space-x-4">
              <button
                onClick={onCancel}
                className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
              >
                Cancel
              </button>
              <button
                onClick={onConfirm}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                Confirm
              </button>
            </div>
          </div>
        </div>
      );
    }

    function Homepage() {
      const [developerId] = React.useState(localStorage.getItem('developer_id') || '');
      const [userName] = React.useState(localStorage.getItem('user_name') || 'User');
      const [email] = React.useState(localStorage.getItem('email') || '');
      const [password] = React.useState(localStorage.getItem('password') || '');
      const [permissions, setPermissions] = React.useState(localStorage.getItem('permissions') || 'low');
      const [activeTab, setActiveTab] = React.useState('activities');
      const [activities, setActivities] = React.useState([]);
      const [projects, setProjects] = React.useState([]);
      const [tasks, setTasks] = React.useState([]);
      const [developers, setDevelopers] = React.useState([]);
      const [logs, setLogs] = React.useState([]);
      const [dropdownData, setDropdownData] = React.useState({ developers: [], projects: [], tasks: [] });
      const [newActivity, setNewActivity] = React.useState({
        project_id: '',
        task_id: '',
        details: '',
        status: 'To_Do',
        estimated_days: '',
        created_at: ''
      });
      const [newProject, setNewProject] = React.useState({
        name: '',
        description: '',
        status: 'Planning',
        delivery_date: '',
        priority: ''
      });
      const [newTask, setNewTask] = React.useState({
        title: '',
        description: ''
      });
      const [newDeveloper, setNewDeveloper] = React.useState({
        first_name: '',
        last_name: '',
        email: '',
        password: '',
        permissions: 'low'
      });
      const [editActivity, setEditActivity] = React.useState(null);
      const [editProject, setEditProject] = React.useState(null);
      const [editTask, setEditTask] = React.useState(null);
      const [editDeveloper, setEditDeveloper] = React.useState(null);
      const [error, setError] = React.useState('');
      const [success, setSuccess] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      const [modal, setModal] = React.useState({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
      const API_BASE_URL = 'http://localhost:8000';

      const activityFormRef = React.useRef(null);
      const projectFormRef = React.useRef(null);
      const taskFormRef = React.useRef(null);
      const developerFormRef = React.useRef(null);

      React.useEffect(() => {
        if (!developerId || !email || !password) {
          window.location.href = 'login.html';
          return;
        }
        const fetchData = async () => {
          setLoading(true);
          try {
            const permResponse = await fetch(`${API_BASE_URL}/me?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
            if (!permResponse.ok) throw new Error('Failed to load permissions: ' + permResponse.statusText);
            const permData = await permResponse.json();
            setPermissions(permData.permissions || 'low');
            localStorage.setItem('permissions', permData.permissions || 'low');

            const actResponse = await fetch(`${API_BASE_URL}/activities?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
            if (!actResponse.ok) throw new Error('Failed to load activities: ' + actResponse.statusText);
            const actData = await actResponse.json();
            setActivities(Array.isArray(actData) ? actData : []);

            const projResponse = await fetch(`${API_BASE_URL}/projects?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
            if (!projResponse.ok) throw new Error('Failed to load projects: ' + projResponse.statusText);
            const projData = await projResponse.json();
            const normalizedProjects = (projData || []).map(project => ({
              project_id: project.project_id,
              name: project.name || '',
              description: project.description || null,
              status: project.status || 'Planning',
              delivery_date: project.delivery_date || null,
              priority: project.priority || null
            }));
            setProjects(normalizedProjects);

            const taskResponse = await fetch(`${API_BASE_URL}/tasks?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
            if (!taskResponse.ok) throw new Error('Failed to load tasks: ' + taskResponse.statusText);
            const taskData = await taskResponse.json();
            const normalizedTasks = (taskData || []).map(task => ({
              task_id: task.task_id,
              title: task.title || '',
              description: task.description || null
            }));
            setTasks(normalizedTasks);

            if (permData.permissions === 'high') {
              try {
                const devResponse = await fetch(`${API_BASE_URL}/developers?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
                if (!devResponse.ok) throw new Error('Failed to load developers: ' + devResponse.statusText);
                const devData = await devResponse.json();
                const normalizedDevelopers = (devData || []).map(developer => ({
                  developer_id: developer.developer_id,
                  first_name: developer.first_name || '',
                  last_name: developer.last_name || '',
                  name: `${developer.first_name} ${developer.last_name}`.trim() || `Developer ${developer.developer_id}`,
                  email: developer.email || '',
                  permissions: developer.permissions || 'low'
                }));
                setDevelopers(normalizedDevelopers);

                const logsResponse = await fetch(`${API_BASE_URL}/logs?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
                if (!logsResponse.ok) {
                  const errorText = await logsResponse.text();
                  throw new Error(`Failed to fetch logs: ${errorText || logsResponse.statusText} (Status: ${logsResponse.status})`);
                }
                const logsData = await logsResponse.json();
                setLogs(Array.isArray(logsData) ? logsData : []);
              } catch (err) {
                setError(err.message);
                console.error('Logs fetch error:', err);
              }
            }

            const dropdownResponse = await fetch(`${API_BASE_URL}/dropdown-data`);
            if (!dropdownResponse.ok) throw new Error('Failed to load dropdown data: ' + dropdownResponse.statusText);
            const dropData = await dropdownResponse.json();
            const normalizedDropdownDevelopers = (dropData.developers || []).map(developer => ({
              developer_id: developer.developer_id,
              name: developer.name || `Developer ${developer.developer_id}`
            }));
            if (!normalizedDropdownDevelopers.find(d => d.developer_id === parseInt(developerId))) {
              normalizedDropdownDevelopers.push({
                developer_id: parseInt(developerId),
                name: userName || `Developer ${developerId}`
              });
            }
            setDropdownData({
              developers: normalizedDropdownDevelopers,
              projects: (dropData.projects || []).map(project => ({
                project_id: project.project_id,
                name: project.name || '',
                description: project.description || null
              })),
              tasks: (dropData.tasks || []).map(task => ({
                task_id: task.task_id,
                title: task.title || ''
              }))
            });
          } catch (err) {
            setError(err.message);
            console.error('Fetch error:', err);
          } finally {
            setLoading(false);
          }
        };
        fetchData();
      }, [developerId, email, password]);

      const showConfirmation = (title, message, onConfirm) => {
        setModal({
          isOpen: true,
          title,
          message,
          onConfirm,
          onCancel: () => setModal({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} })
        });
      };

      const handleTabChange = (tab) => {
        setActiveTab(tab);
        setError('');
        setSuccess('');
        setEditActivity(null);
        setEditProject(null);
        setEditTask(null);
        setEditDeveloper(null);
        setModal({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
      };

      const handleEditActivity = (activity) => {
        if (permissions === 'medium' && parseInt(developerId) !== activity.developer_id) {
          setError('You can only edit your own activities.');
          return;
        }
        setEditActivity(activity);
        setTimeout(() => { if (activityFormRef.current) activityFormRef.current.scrollIntoView({ behavior: 'smooth' }); }, 0);
      };

      const handleEditProject = (project) => {
        setEditProject(project);
        setTimeout(() => { if (projectFormRef.current) projectFormRef.current.scrollIntoView({ behavior: 'smooth' }); }, 0);
      };

      const handleEditTask = (task) => {
        setEditTask(task);
        setTimeout(() => { if (taskFormRef.current) taskFormRef.current.scrollIntoView({ behavior: 'smooth' }); }, 0);
      };

      const handleEditDeveloper = (developer) => {
        if (developer.permissions === 'high') {
          setError('Cannot edit a developer with high permissions');
          return;
        }
        setEditDeveloper({
          developer_id: developer.developer_id,
          first_name: developer.first_name,
          last_name: developer.last_name,
          email: developer.email,
          permissions: developer.permissions,
          password: ''
        });
        setTimeout(() => { if (developerFormRef.current) developerFormRef.current.scrollIntoView({ behavior: 'smooth' }); }, 0);
      };

      const handleAddActivity = async () => {
        setLoading(true);
        if (!newActivity.status || !['To_Do', 'In_Progress', 'Done'].includes(newActivity.status)) {
          setError('Please select a valid status (To Do, In Progress, or Done).');
          setLoading(false);
          return;
        }
        if (!newActivity.project_id || !newActivity.task_id) {
          setError('Please select a project and task.');
          setLoading(false);
          return;
        }
        const estimatedDays = parseInt(newActivity.estimated_days);
        if (newActivity.estimated_days && (isNaN(estimatedDays) || estimatedDays < 0 || estimatedDays > 10000)) {
          setError('Estimated days must be a number between 0 and 10,000.');
          setLoading(false);
          return;
        }
        if (newActivity.created_at && !/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(newActivity.created_at)) {
          setError('Created At must be in the format YYYY-MM-DDThh:mm (e.g., 2025-07-16T08:59).');
          setLoading(false);
          return;
        }
        const activityData = {
          project_id: parseInt(newActivity.project_id),
          task_id: parseInt(newActivity.task_id),
          details: newActivity.details || null,
          status: newActivity.status,
          estimated_days: estimatedDays || null,
          created_at: newActivity.created_at || new Date().toISOString().slice(0, 16)
        };
        try {
          const response = await fetch(`${API_BASE_URL}/activities?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(activityData)
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error('Failed to add activity: ' + (errorText || response.statusText));
          }
          const data = await response.json();
          const newActivityWithDeveloper = {
            ...data,
            developer_id: data.developer_id || parseInt(developerId)
          };
          setActivities([...activities, newActivityWithDeveloper]);
          if (!dropdownData.developers.find(d => d.developer_id === newActivityWithDeveloper.developer_id)) {
            setDropdownData({
              ...dropdownData,
              developers: [
                ...dropdownData.developers,
                {
                  developer_id: newActivityWithDeveloper.developer_id,
                  name: userName || `Developer ${newActivityWithDeveloper.developer_id}`
                }
              ]
            });
          }
          setSuccess('Activity added successfully');
          setNewActivity({ project_id: '', task_id: '', details: '', status: 'To_Do', estimated_days: '', created_at: '' });
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const updateActivityStatus = async (activityId, newStatus) => {
        showConfirmation(
          'Confirm Status Update',
          'Are you sure you want to update the status of this activity?',
          async () => {
            setLoading(true);
            try {
              const response = await fetch(`${API_BASE_URL}/activities/${activityId}/status?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
              });
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error('Failed to update status: ' + (errorText || response.statusText));
              }
              setActivities(activities.map(activity => 
                activity.activity_id === activityId ? { ...activity, status: newStatus } : activity
              ));
              setSuccess('Status updated successfully');
            } catch (err) {
              setError(err.message);
            } finally {
              setModal({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
              setLoading(false);
            }
          }
        );
      };

      const updateActivity = async (activity) => {
        if (permissions === 'medium' && parseInt(developerId) !== activity.developer_id) {
          setError('You can only edit the status of your own activities.');
          setLoading(false);
          return;
        }
        showConfirmation(
          'Confirm Activity Update',
          'Are you sure you want to update this activity?',
          async () => {
            setLoading(true);
            const estimatedDays = parseInt(activity.estimated_days);
            if (activity.estimated_days && (isNaN(estimatedDays) || estimatedDays < 0 || estimatedDays > 10000)) {
              setError('Estimated days must be a number between 0 and 10,000.');
              setLoading(false);
              return;
            }
            if (activity.created_at && !/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(activity.created_at)) {
              setError('Created At must be in the format YYYY-MM-DDThh:mm (e.g., 2025-07-16T08:59).');
              setLoading(false);
              return;
            }
            const activityData = permissions === 'medium' ? { status: activity.status } : {
              project_id: parseInt(activity.project_id),
              task_id: parseInt(activity.task_id),
              details: activity.details || null,
              status: activity.status,
              estimated_days: estimatedDays || null,
              created_at: activity.created_at || new Date().toISOString().slice(0, 16)
            };
            try {
              const response = await fetch(`${API_BASE_URL}/activities/${activity.activity_id}?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(activityData)
              });
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error('Failed to update activity: ' + (errorText || response.statusText));
              }
              const data = await response.json();
              setActivities(activities.map(a => a.activity_id === activity.activity_id ? data : a));
              setEditActivity(null);
              setSuccess('Activity updated successfully');
            } catch (err) {
              setError(err.message);
            } finally {
              setModal({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
              setLoading(false);
            }
          }
        );
      };

      const deleteActivity = async (activityId) => {
        showConfirmation(
          'Confirm Activity Deletion',
          'Are you sure you want to delete this activity? This action cannot be undone.',
          async () => {
            setLoading(true);
            try {
              const response = await fetch(`${API_BASE_URL}/activities/${activityId}?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
                method: 'DELETE'
              });
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error('Failed to delete activity: ' + (errorText || response.statusText));
              }
              setActivities(activities.filter(a => a.activity_id !== activityId));
              setSuccess('Activity deleted successfully');
            } catch (err) {
              setError(err.message);
            } finally {
              setModal({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
              setLoading(false);
            }
          }
        );
      };

      const handleAddProject = async () => {
        setLoading(true);
        if (!newProject.status || !['Planning', 'In_Progress', 'On_Hold', 'Completed'].includes(newProject.status)) {
          setError('Please select a valid status (Planning, In Progress, On Hold, or Completed).');
          setLoading(false);
          return;
        }
        if (!newProject.name) {
          setError('Project name is required.');
          setLoading(false);
          return;
        }
        const projectData = {
          name: newProject.name,
          description: newProject.description || null,
          status: newProject.status,
          delivery_date: newProject.delivery_date || null,
          priority: newProject.priority || null
        };
        try {
          const response = await fetch(`${API_BASE_URL}/projects?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(projectData)
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error('Failed to add project: ' + (errorText || response.statusText));
          }
          const data = await response.json();
          setProjects([...projects, data]);
          setDropdownData({ ...dropdownData, projects: [...dropdownData.projects, data] });
          setSuccess('Project added successfully');
          setNewProject({ name: '', description: '', status: 'Planning', delivery_date: '', priority: '' });
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const updateProject = async (project) => {
        showConfirmation(
          'Confirm Project Update',
          'Are you sure you want to update this project?',
          async () => {
            setLoading(true);
            const projectData = {
              name: project.name,
              description: project.description || null,
              status: project.status,
              delivery_date: project.delivery_date || null,
              priority: project.priority || null
            };
            try {
              const response = await fetch(`${API_BASE_URL}/projects/${project.project_id}?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(projectData)
              });
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error('Failed to update project: ' + (errorText || response.statusText));
              }
              const data = await response.json();
              setProjects(projects.map(p => p.project_id === project.project_id ? data : p));
              setDropdownData({
                ...dropdownData,
                projects: dropdownData.projects.map(p => p.project_id === project.project_id ? data : p)
              });
              setEditProject(null);
              setSuccess('Project updated successfully');
            } catch (err) {
              setError(err.message);
            } finally {
              setModal({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
              setLoading(false);
            }
          }
        );
      };

      const deleteProject = async (projectId) => {
        showConfirmation(
          'Confirm Project Deletion',
          'Are you sure you want to delete this project? This action cannot be undone.',
          async () => {
            setLoading(true);
            try {
              const response = await fetch(`${API_BASE_URL}/projects/${projectId}?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
                method: 'DELETE'
              });
              if (!response.ok) {
                const errorText = await response.text();
                if (errorText.includes('Cannot delete or update a parent row') || errorText.includes('1451')) {
                  throw new Error('Cannot delete project because it has associated activities. Please delete the activities first.');
                }
                throw new Error('Failed to delete project: ' + (errorText || response.statusText));
              }
              setProjects(projects.filter(p => p.project_id !== projectId));
              setDropdownData({ ...dropdownData, projects: dropdownData.projects.filter(p => p.project_id !== projectId) });
              setSuccess('Project deleted successfully');
            } catch (err) {
              setError(err.message);
            } finally {
              setModal({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
              setLoading(false);
            }
          }
        );
      };

      const handleAddTask = async () => {
        setLoading(true);
        if (!newTask.title) {
          setError('Task title is required.');
          setLoading(false);
          return;
        }
        const taskData = {
          title: newTask.title,
          description: newTask.description || null
        };
        try {
          const response = await fetch(`${API_BASE_URL}/tasks?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(taskData)
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error('Failed to add task: ' + (errorText || response.statusText));
          }
          const data = await response.json();
          setTasks([...tasks, data]);
          setDropdownData({ ...dropdownData, tasks: [...dropdownData.tasks, data] });
          setSuccess('Task added successfully');
          setNewTask({ title: '', description: '' });
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const updateTask = async (task) => {
        showConfirmation(
          'Confirm Task Update',
          'Are you sure you want to update this task?',
          async () => {
            setLoading(true);
            const taskData = {
              title: task.title,
              description: task.description || null
            };
            try {
              const response = await fetch(`${API_BASE_URL}/tasks/${task.task_id}?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(taskData)
              });
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error('Failed to update task: ' + (errorText || response.statusText));
              }
              const data = await response.json();
              setTasks(tasks.map(t => t.task_id === task.task_id ? data : t));
              setDropdownData({
                ...dropdownData,
                tasks: dropdownData.tasks.map(t => t.task_id === task.task_id ? data : t)
              });
              setEditTask(null);
              setSuccess('Task updated successfully');
            } catch (err) {
              setError(err.message);
            } finally {
              setModal({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
              setLoading(false);
            }
          }
        );
      };

      const deleteTask = async (taskId) => {
        showConfirmation(
          'Confirm Task Deletion',
          'Are you sure you want to delete this task? This action cannot be undone.',
          async () => {
            setLoading(true);
            try {
              const response = await fetch(`${API_BASE_URL}/tasks/${taskId}?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
                method: 'DELETE'
              });
              if (!response.ok) {
                const errorText = await response.text();
                if (errorText.includes('Cannot delete or update a parent row') || errorText.includes('1451')) {
                  throw new Error('Cannot delete task because it has associated activities. Please delete the activities first.');
                }
                throw new Error('Failed to delete task: ' + (errorText || response.statusText));
              }
              setTasks(tasks.filter(t => t.task_id !== taskId));
              setDropdownData({ ...dropdownData, tasks: dropdownData.tasks.filter(t => t.task_id !== taskId) });
              setSuccess('Task deleted successfully');
            } catch (err) {
              setError(err.message);
            } finally {
              setModal({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
              setLoading(false);
            }
          }
        );
      };

      const handleAddDeveloper = async () => {
        setLoading(true);
        if (!newDeveloper.first_name || !newDeveloper.last_name || !newDeveloper.email || !newDeveloper.password) {
          setError('All fields except permissions are required.');
          setLoading(false);
          return;
        }
        if (newDeveloper.password.length > 50) {
          setError('Password must be 50 characters or less.');
          setLoading(false);
          return;
        }
        const developerData = {
          first_name: newDeveloper.first_name,
          last_name: newDeveloper.last_name,
          email: newDeveloper.email,
          password: newDeveloper.password,
          permissions: newDeveloper.permissions
        };
        try {
          const response = await fetch(`${API_BASE_URL}/developers?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(developerData)
          });
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error('Failed to add developer: ' + (errorText || response.statusText));
          }
          const data = await response.json();
          const newDev = {
            developer_id: data.developer_id,
            first_name: data.first_name,
            last_name: data.last_name,
            name: `${data.first_name} ${data.last_name}`.trim() || `Developer ${data.developer_id}`,
            email: data.email,
            permissions: data.permissions
          };
          setDevelopers([...developers, newDev]);
          setDropdownData({ ...dropdownData, developers: [...dropdownData.developers, newDev] });
          setSuccess('Developer added successfully');
          setNewDeveloper({ first_name: '', last_name: '', email: '', password: '', permissions: 'low' });
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const updateDeveloper = async (developer) => {
        if (developer.permissions === 'high') {
          setError('Cannot edit a developer with high permissions');
          return;
        }
        showConfirmation(
          'Confirm Developer Update',
          'Are you sure you want to update this developer?',
          async () => {
            setLoading(true);
            if (developer.password && developer.password.length > 50) {
              setError('Password must be 50 characters or less.');
              setLoading(false);
              return;
            }
            const developerData = {
              first_name: developer.first_name,
              last_name: developer.last_name,
              email: developer.email,
              permissions: developer.permissions
            };
            if (developer.password && developer.password.trim()) {
              developerData.password = developer.password;
            }
            try {
              const response = await fetch(`${API_BASE_URL}/developers/${developer.developer_id}?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(developerData)
              });
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error('Failed to update developer: ' + (errorText || response.statusText));
              }
              const data = await response.json();
              const updatedDev = {
                developer_id: data.developer_id,
                first_name: data.first_name,
                last_name: data.last_name,
                name: `${data.first_name} ${data.last_name}`.trim() || `Developer ${data.developer_id}`,
                email: data.email,
                permissions: data.permissions
              };
              setDevelopers(developers.map(d => d.developer_id === developer.developer_id ? updatedDev : d));
              setDropdownData({
                ...dropdownData,
                developers: dropdownData.developers.map(d => 
                  d.developer_id === developer.developer_id ? { developer_id: data.developer_id, name: `${data.first_name} ${data.last_name}`.trim() || `Developer ${data.developer_id}` } : d
                )
              });
              setEditDeveloper(null);
              setSuccess('Developer updated successfully');
            } catch (err) {
              setError(err.message);
            } finally {
              setModal({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
              setLoading(false);
            }
          }
        );
      };

      const deleteDeveloper = async (developerId) => {
        const developer = developers.find(d => d.developer_id === developerId);
        if (developer && developer.permissions === 'high') {
          setError('Cannot delete a developer with high permissions');
          return;
        }
        showConfirmation(
          'Confirm Developer Deletion',
          'Are you sure you want to delete this developer? This action cannot be undone.',
          async () => {
            setLoading(true);
            try {
              const response = await fetch(`${API_BASE_URL}/developers/${developerId}?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`, {
                method: 'DELETE'
              });
              if (!response.ok) {
                const errorText = await response.text();
                if (errorText.includes('Cannot delete or update a parent row') || errorText.includes('1451')) {
                  throw new Error('Cannot delete developer because it has associated activities. Please delete the activities first.');
                }
                throw new Error('Failed to delete developer: ' + (errorText || response.statusText));
              }
              setDevelopers(developers.filter(d => d.developer_id !== developerId));
              setDropdownData({ ...dropdownData, developers: dropdownData.developers.filter(d => d.developer_id !== developerId) });
              setSuccess('Developer deleted successfully');
            } catch (err) {
              setError(err.message);
            } finally {
              setModal({ isOpen: false, title: '', message: '', onConfirm: () => {}, onCancel: () => {} });
              setLoading(false);
            }
          }
        );
      };

      const getProjectName = (id) => {
        const project = dropdownData.projects.find(p => p.project_id === id);
        return project ? `${project.name} (ID: ${project.project_id})` : `Project ${id}`;
      };

      const getTaskTitle = (id) => {
        const task = dropdownData.tasks.find(t => t.task_id === id);
        return task ? `${task.title} (ID: ${task.task_id})` : `Task ${id}`;
      };

      const getDeveloperName = (id) => {
        const developer = dropdownData.developers.find(d => d.developer_id === id);
        return developer && developer.name && developer.name.trim() ? developer.name : `Developer ${id}`;
      };

      const handleLogout = () => {
        localStorage.clear();
        window.location.href = 'login.html';
      };

      return (
        <div className="bg-white rounded-lg shadow-md p-6 sm:p-8 md:p-10">
          <div className="flex justify-between items-center mb-6">
            <div>
              <h1 className="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">Developer Dashboard</h1>
              <p className="text-sm md:text-base text-gray-600">Welcome, {userName} ({permissions} Permission)</p>
            </div>
            <button onClick={handleLogout} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Logout</button>
          </div>
          {error && <div className="mb-6 p-4 bg-red-100 text-red-700 rounded-lg">{error}</div>}
          {success && <div className="mb-6 p-4 bg-green-100 text-green-700 rounded-lg">{success}</div>}
          {loading && <div className="mb-6 p-4 text-center text-gray-600">Loading...</div>}
          <ConfirmationModal
            isOpen={modal.isOpen}
            title={modal.title}
            message={modal.message}
            onConfirm={modal.onConfirm}
            onCancel={modal.onCancel}
          />
          {!loading && (
            <>
              <div className="mb-6">
                <div className="flex space-x-4 border-b">
                  <button 
                    onClick={() => handleTabChange('activities')} 
                    className={`px-4 py-2 font-medium ${activeTab === 'activities' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                  >
                    Activities
                  </button>
                  {(permissions === 'medium' || permissions === 'high') && (
                    <>
                      <button 
                        onClick={() => handleTabChange('projects')} 
                        className={`px-4 py-2 font-medium ${activeTab === 'projects' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                      >
                        Projects
                      </button>
                      <button 
                        onClick={() => handleTabChange('tasks')} 
                        className={`px-4 py-2 font-medium ${activeTab === 'tasks' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                      >
                        Tasks
                      </button>
                    </>
                  )}
                  {permissions === 'high' && (
                    <>
                      <button 
                        onClick={() => handleTabChange('developers')} 
                        className={`px-4 py-2 font-medium ${activeTab === 'developers' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                      >
                        Developers
                      </button>
                      <button 
                        onClick={() => handleTabChange('logs')} 
                        className={`px-4 py-2 font-medium ${activeTab === 'logs' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                      >
                        Logs
                      </button>
                    </>
                  )}
                </div>
              </div>

              {activeTab === 'logs' && permissions === 'high' && (
                <>
                  <h2 className="text-lg md:text-xl font-semibold mb-6 text-gray-700">System Logs</h2>
                  {logs.length === 0 ? (
                    <p className="text-gray-600 mb-6">No logs available.</p>
                  ) : (
                    <div className="p-4 bg-white rounded-lg shadow mb-8 overflow-x-auto">
                      <table className="w-full border-collapse min-w-[600px]">
                        <thead>
                          <tr className="bg-gray-200">
                            <th className="p-2 text-xs md:text-sm font-medium text-gray-700">Log ID</th>
                            <th className="p-2 text-xs md:text-sm font-medium text-gray-700">Developer</th>
                            <th className="p-2 text-xs md:text-sm font-medium text-gray-700">Action</th>
                            <th className="p-2 text-xs md:text-sm font-medium text-gray-700">Description</th>
                            <th className="p-2 text-xs md:text-sm font-medium text-gray-700">Logged At</th>
                          </tr>
                        </thead>
                        <tbody>
                          {logs.map(log => (
                            <tr key={log.log_id} className="border-b">
                              <td className="p-2 text-xs md:text-sm text-gray-600">{log.log_id}</td>
                              <td className="p-2 text-xs md:text-sm text-gray-600">{getDeveloperName(log.developer_id)}</td>
                              <td className="p-2 text-xs md:text-sm text-gray-600">{log.action}</td>
                              <td className="p-2 text-xs md:text-sm text-gray-600">{log.description || '-'}</td>
                              <td className="p-2 text-xs md:text-sm text-gray-600">{new Date(log.log_at).toLocaleString()}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </>
              )}

              {activeTab === 'activities' && (
                <>
                  <h2 className="text-lg md:text-xl font-semibold mb-6 text-gray-700">{permissions === 'high' ? 'All Activities' : 'Your Activities'}</h2>
                  {activities.length === 0 ? (
                    <p className="text-gray-600 mb-6">No activities found.</p>
                  ) : (
                    <div className="p-4 bg-white rounded-lg shadow mb-8 overflow-x-auto">
                      <table className="w-full border-collapse min-w-[700px]">
                        <thead>
                          <tr className="bg-gray-200">
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Developer</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Project</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Task</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Details</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Status</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Est. Days</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Created At</th>
                            {(permissions === 'high' || permissions === 'medium') && (
                              <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Actions</th>
                            )}
                          </tr>
                        </thead>
                        <tbody>
                          {activities.map(activity => {
                            const canEdit = permissions === 'high';
                            return (
                              <tr key={activity.activity_id} className="border-b">
                                <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{getDeveloperName(activity.developer_id)}</td>
                                <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{getProjectName(activity.project_id)}</td>
                                <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{getTaskTitle(activity.task_id)}</td>
                                <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{activity.details || '-'}</td>
                                <td className="p-2 md:p-3 text-xs md:text-sm">
                                  <select
                                    value={activity.status}
                                    onChange={(e) => updateActivityStatus(activity.activity_id, e.target.value)}
                                    className={`w-full p-1 rounded border text-xs md:text-sm
                                      ${((permissions === 'low' || permissions === 'medium') && parseInt(developerId) !== activity.developer_id)
                                        ? 'bg-gray-300 text-gray-800 border-gray-500 opacity-100 cursor-not-allowed'
                                        : 'border-gray-300'}
                                    `}
                                    disabled={(permissions === 'low' || permissions === 'medium') && parseInt(developerId) !== activity.developer_id}
                                  >
                                    <option value="To_Do">To Do</option>
                                    <option value="In_Progress">In Progress</option>
                                    <option value="Done">Done</option>
                                  </select>
                                </td>
                                <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{activity.estimated_days || '-'}</td>
                                <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{activity.created_at ? new Date(activity.created_at).toLocaleString() : '-'}</td>
                                {(permissions === 'high' || permissions === 'medium') && (
                                  <td className="p-2 md:p-3 text-xs md:text-sm">
                                    {canEdit && (
                                      <button onClick={() => handleEditActivity(activity)} className="text-blue-600 hover:underline mr-2">Edit</button>
                                    )}
                                    {permissions === 'high' && (
                                      <button onClick={() => deleteActivity(activity.activity_id)} className="text-red-600 hover:underline">Delete</button>
                                    )}
                                  </td>
                                )}
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}
                  <h3 ref={activityFormRef} className="text-md md:text-lg font-semibold mb-4 text-gray-700">{editActivity ? 'Edit Activity' : 'Add New Activity'}</h3>
                  <div className="space-y-4 mb-8">
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Project</label>
                      <select
                        value={editActivity ? editActivity.project_id : newActivity.project_id}
                        onChange={(e) => editActivity ? setEditActivity({ ...editActivity, project_id: e.target.value }) : setNewActivity({ ...newActivity, project_id: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        required
                        disabled={editActivity && permissions === 'medium'}
                      >
                        <option value="">Select Project</option>
                        {dropdownData.projects.map(project => (
                          <option key={project.project_id} value={project.project_id}>{project.name} (ID: {project.project_id})</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Task</label>
                      <select
                        value={editActivity ? editActivity.task_id : newActivity.task_id}
                        onChange={(e) => editActivity ? setEditActivity({ ...editActivity, task_id: e.target.value }) : setNewActivity({ ...newActivity, task_id: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        required
                        disabled={editActivity && permissions === 'medium'}
                      >
                        <option value="">Select Task</option>
                        {dropdownData.tasks.map(task => (
                          <option key={task.task_id} value={task.task_id}>{task.title} (ID: {task.task_id})</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Details</label>
                      <input
                        type="text"
                        value={editActivity ? editActivity.details || '' : newActivity.details}
                        onChange={(e) => editActivity ? setEditActivity({ ...editActivity, details: e.target.value }) : setNewActivity({ ...newActivity, details: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        disabled={editActivity && permissions === 'medium'}
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Status</label>
                      <select
                        value={editActivity ? editActivity.status : newActivity.status}
                        onChange={(e) => editActivity ? setEditActivity({ ...editActivity, status: e.target.value }) : setNewActivity({ ...newActivity, status: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        required
                      >
                        <option value="To_Do">To Do</option>
                        <option value="In_Progress">In Progress</option>
                        <option value="Done">Done</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Estimated Days (max 10,000)</label>
                      <input
                        type="number"
                        value={editActivity ? editActivity.estimated_days || '' : newActivity.estimated_days}
                        onChange={(e) => editActivity ? setEditActivity({ ...editActivity, estimated_days: e.target.value }) : setNewActivity({ ...newActivity, estimated_days: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        min="0"
                        max="10000"
                        disabled={editActivity && permissions === 'medium'}
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Created At (YYYY-MM-DDThh:mm, optional)</label>
                      <input
                        type="datetime-local"
                        value={editActivity ? editActivity.created_at || '' : newActivity.created_at}
                        onChange={(e) => editActivity ? setEditActivity({ ...editActivity, created_at: e.target.value }) : setNewActivity({ ...newActivity, created_at: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        disabled={editActivity && permissions === 'medium'}
                      />
                    </div>
                    <button 
                      onClick={editActivity ? () => updateActivity(editActivity) : handleAddActivity} 
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      {editActivity ? 'Update Activity' : 'Add Activity'}
                    </button>
                    {editActivity && (
                      <button 
                        onClick={() => setEditActivity(null)} 
                        className="ml-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                      >
                        Cancel Edit
                      </button>
                    )}
                  </div>
                </>
              )}
              {activeTab === 'projects' && (permissions === 'medium' || permissions === 'high') && (
                <>
                  <h2 className="text-lg md:text-xl font-semibold mb-6 text-gray-700">Projects</h2>
                  {projects.length === 0 ? (
                    <p className="text-gray-600 mb-6">No projects found.</p>
                  ) : (
                    <div className="p-4 bg-white rounded-lg shadow mb-8 overflow-x-auto">
                      <table className="w-full border-collapse min-w-[600px]">
                        <thead>
                          <tr className="bg-gray-200">
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Name</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Description</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Status</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Delivery Date</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Priority</th>
                            {permissions === 'high' && (
                              <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Actions</th>
                            )}
                          </tr>
                        </thead>
                        <tbody>
                          {projects.map(project => (
                            <tr key={project.project_id} className="border-b">
                              <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{project.name}</td>
                              <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{project.description || '-'}</td>
                              <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{project.status}</td>
                              <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{project.delivery_date || '-'}</td>
                              <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{project.priority || '-'}</td>
                              {permissions === 'high' && (
                                <td className="p-2 md:p-3 text-xs md:text-sm">
                                  <button onClick={() => handleEditProject(project)} className="text-blue-600 hover:underline mr-2">Edit</button>
                                  <button onClick={() => deleteProject(project.project_id)} className="text-red-600 hover:underline">Delete</button>
                                </td>
                              )}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                  <h3 ref={projectFormRef} className="text-md md:text-lg font-semibold mb-4 text-gray-700">{editProject ? 'Edit Project' : 'Add New Project'}</h3>
                  <div className="space-y-4 mb-8">
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Name</label>
                      <input
                        type="text"
                        value={editProject ? editProject.name : newProject.name}
                        onChange={(e) => editProject ? setEditProject({ ...editProject, name: e.target.value }) : setNewProject({ ...newProject, name: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Description</label>
                      <input
                        type="text"
                        value={editProject ? editProject.description || '' : newProject.description}
                        onChange={(e) => editProject ? setEditProject({ ...editProject, description: e.target.value }) : setNewProject({ ...newProject, description: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Status</label>
                      <select
                        value={editProject ? editProject.status : newProject.status}
                        onChange={(e) => editProject ? setEditProject({ ...editProject, status: e.target.value }) : setNewProject({ ...newProject, status: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        required
                      >
                        <option value="Planning">Planning</option>
                        <option value="In_Progress">In Progress</option>
                        <option value="On_Hold">On Hold</option>
                        <option value="Completed">Completed</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Delivery Date</label>
                      <input
                        type="date"
                        value={editProject ? editProject.delivery_date || '' : newProject.delivery_date}
                        onChange={(e) => editProject ? setEditProject({ ...editProject, delivery_date: e.target.value }) : setNewProject({ ...newProject, delivery_date: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Priority</label>
                      <select
                        value={editProject ? editProject.priority || '' : newProject.priority}
                        onChange={(e) => editProject ? setEditProject({ ...editProject, priority: e.target.value }) : setNewProject({ ...newProject, priority: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                      >
                        <option value="">Select Priority</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                      </select>
                    </div>
                    <button 
                      onClick={editProject ? () => updateProject(editProject) : handleAddProject} 
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      {editProject ? 'Update Project' : 'Add Project'}
                    </button>
                    {editProject && (
                      <button 
                        onClick={() => setEditProject(null)} 
                        className="ml-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                      >
                        Cancel Edit
                      </button>
                    )}
                  </div>
                </>
              )}
              {activeTab === 'tasks' && (permissions === 'medium' || permissions === 'high') && (
                <>
                  <h2 className="text-lg md:text-xl font-semibold mb-6 text-gray-700">Tasks</h2>
                  {tasks.length === 0 ? (
                    <p className="text-gray-600 mb-6">No tasks found.</p>
                  ) : (
                    <div className="p-4 bg-white rounded-lg shadow mb-8 overflow-x-auto">
                      <table className="w-full border-collapse min-w-[600px]">
                        <thead>
                          <tr className="bg-gray-200">
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Title</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Description</th>
                            {permissions === 'high' && (
                              <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Actions</th>
                            )}
                          </tr>
                        </thead>
                        <tbody>
                          {tasks.map(task => (
                            <tr key={task.task_id} className="border-b">
                              <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{task.title}</td>
                              <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{task.description || '-'}</td>
                              {permissions === 'high' && (
                                <td className="p-2 md:p-3 text-xs md:text-sm">
                                  <button onClick={() => handleEditTask(task)} className="text-blue-600 hover:underline mr-2">Edit</button>
                                  <button onClick={() => deleteTask(task.task_id)} className="text-red-600 hover:underline">Delete</button>
                                </td>
                              )}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                  <h3 ref={taskFormRef} className="text-md md:text-lg font-semibold mb-4 text-gray-700">{editTask ? 'Edit Task' : 'Add New Task'}</h3>
                  <div className="space-y-4 mb-8">
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Title</label>
                      <input
                        type="text"
                        value={editTask ? editTask.title : newTask.title}
                        onChange={(e) => editTask ? setEditTask({ ...editTask, title: e.target.value }) : setNewTask({ ...newTask, title: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Description</label>
                      <input
                        type="text"
                        value={editTask ? editTask.description || '' : newTask.description}
                        onChange={(e) => editTask ? setEditTask({ ...editTask, description: e.target.value }) : setNewTask({ ...newTask, description: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                      />
                    </div>
                    <button 
                      onClick={editTask ? () => updateTask(editTask) : handleAddTask} 
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      {editTask ? 'Update Task' : 'Add Task'}
                    </button>
                    {editTask && (
                      <button 
                        onClick={() => setEditTask(null)} 
                        className="ml-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                      >
                        Cancel Edit
                      </button>
                    )}
                  </div>
                </>
              )}
              {activeTab === 'developers' && permissions === 'high' && (
                <>
                  <h2 className="text-lg md:text-xl font-semibold mb-6 text-gray-700">Developers</h2>
                  {developers.length === 0 ? (
                    <p className="text-gray-600 mb-6">No developers found.</p>
                  ) : (
                    <div className="p-4 bg-white rounded-lg shadow mb-8 overflow-x-auto">
                      <table className="w-full border-collapse min-w-[600px]">
                        <thead>
                          <tr className="bg-gray-200">
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Name</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Email</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Permissions</th>
                            <th className="p-2 md:p-3 text-left text-xs md:text-sm font-medium text-gray-700">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {developers.map(developer => (
                            <tr key={developer.developer_id} className="border-b">
                              <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{developer.name}</td>
                              <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{developer.email}</td>
                              <td className="p-2 md:p-3 text-xs md:text-sm text-gray-600">{developer.permissions}</td>
                              <td className="p-2 md:p-3 text-xs md:text-sm">
                                <button
                                  onClick={() => handleEditDeveloper(developer)}
                                  className={`mr-2 ${developer.permissions === 'high' ? 'text-gray-400 cursor-not-allowed' : 'text-blue-600 hover:underline'}`}
                                  disabled={developer.permissions === 'high'}
                                >
                                  Edit
                                </button>
                                <button
                                  onClick={() => deleteDeveloper(developer.developer_id)}
                                  className={`mr-2 ${developer.permissions === 'high' ? 'text-gray-400 cursor-not-allowed' : 'text-red-600 hover:underline'}`}
                                  disabled={developer.permissions === 'high'}
                                >
                                  Delete
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                  <h3 ref={developerFormRef} className="text-md md:text-lg font-semibold mb-4 text-gray-700">{editDeveloper ? 'Edit Developer' : 'Add New Developer'}</h3>
                  <div className="space-y-4 mb-8">
                    <div>
                      <label className="block text-sm font-medium text-gray-700">First Name</label>
                      <input
                        type="text"
                        value={editDeveloper ? editDeveloper.first_name : newDeveloper.first_name}
                        onChange={(e) => editDeveloper ? setEditDeveloper({ ...editDeveloper, first_name: e.target.value }) : setNewDeveloper({ ...newDeveloper, first_name: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Last Name</label>
                      <input
                        type="text"
                        value={editDeveloper ? editDeveloper.last_name : newDeveloper.last_name}
                        onChange={(e) => editDeveloper ? setEditDeveloper({ ...editDeveloper, last_name: e.target.value }) : setNewDeveloper({ ...newDeveloper, last_name: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Email</label>
                      <input
                        type="email"
                        value={editDeveloper ? editDeveloper.email : newDeveloper.email}
                        onChange={(e) => editDeveloper ? setEditDeveloper({ ...editDeveloper, email: e.target.value }) : setNewDeveloper({ ...newDeveloper, email: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">{editDeveloper ? 'New Password (Optional, max 50 characters)' : 'Password (max 50 characters)'}</label>
                      <input
                        type="password"
                        value={editDeveloper ? editDeveloper.password : newDeveloper.password}
                        onChange={(e) => editDeveloper ? setEditDeveloper({ ...editDeveloper, password: e.target.value }) : setNewDeveloper({ ...newDeveloper, password: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        required={!editDeveloper}
                        maxLength={50}
                        placeholder={editDeveloper ? 'Leave blank to keep unchanged' : 'Max 50 characters'}
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Permissions</label>
                      <select
                        value={editDeveloper ? editDeveloper.permissions : newDeveloper.permissions}
                        onChange={(e) => editDeveloper ? setEditDeveloper({ ...editDeveloper, permissions: e.target.value }) : setNewDeveloper({ ...newDeveloper, permissions: e.target.value })}
                        className="w-full p-2 border rounded-lg text-sm"
                        required
                      >
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                      </select>
                    </div>
                    <button 
                      onClick={editDeveloper ? () => updateDeveloper(editDeveloper) : handleAddDeveloper} 
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      {editDeveloper ? 'Update Developer' : 'Add Developer'}
                    </button>
                    {editDeveloper && (
                      <button 
                        onClick={() => setEditDeveloper(null)} 
                        className="ml-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                      >
                        Cancel Edit
                      </button>
                    )}
                  </div>
                </>
              )}
            </>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <Homepage />
      </ErrorBoundary>
    );
  </script>
</body>
</html>
